name: Deploy to AKS

on:
  workflow_run:
    workflows: ["Build and Push to Azure Container Registry"]
    types:
      - completed
    branches:
      - main

jobs:
  compute-tag:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Compute image tag
        id: tag
        run: |
          SHORT_SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          echo "tag=main-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

  deploy:
    needs: compute-tag
    uses: oodles-noodles/reusable-workflows/.github/workflows/deploy.yml@main
    with:
      image-name: no-weak-links
      image-tag: ${{ needs.compute-tag.outputs.image-tag }}
      helm-chart-path: ./helm/no-weak-links
      release-name: no-weak-links
    permissions:
      contents: read
      id-token: write
      deployments: write


