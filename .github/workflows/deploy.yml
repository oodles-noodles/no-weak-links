name: Deploy to AKS

on:
  workflow_run:
    workflows: ["Build and Push to Azure Container Registry"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read
  id-token: write
  deployments: write

env:
  REGISTRY: ${{ secrets.ACR_REGISTRY }}
  IMAGE_NAME: no-weak-links

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image reference
        id: image
        run: |
          SHORT_SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          IMAGE_REF="${{ secrets.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:main-${SHORT_SHA}"
          echo "ref=${IMAGE_REF}" >> "$GITHUB_OUTPUT"
          echo "tag=main-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Verify image attestation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh attestation verify "oci://${{ steps.image.outputs.ref }}" \
            --repo "${{ github.repository }}"

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}

      - name: Create GitHub deployment record
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: '${{ github.event.workflow_run.head_sha }}',
              environment: 'production',
              description: 'Deploy to AKS via Helm',
              auto_merge: false,
              required_contexts: []
            });
            return result.data.id;

      - name: Deploy with Helm
        run: |
          helm upgrade --install no-weak-links ./helm/no-weak-links \
            --set image.repository="${{ secrets.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}" \
            --set image.tag="${{ steps.image.outputs.tag }}" \
            --wait

      - name: Update deployment status to success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'success',
              environment: 'production',
              description: 'Deployment succeeded'
            });

      - name: Update deployment status to failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: 'failure',
              environment: 'production',
              description: 'Deployment failed'
            });
